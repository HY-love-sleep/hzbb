# 中化项目用户中心改造

## 1、多租户管理

### 0.改动模块

- expos-service-expos-dictionary

  分支：feature/tenant

- 数据库表中deleted字段默认为0， id设置为自增

### 1.要求

支持对不同机构用户进行多租户管理，实现各类安全能力服务访问管控与计费。户可按公司组织架构分级配置系统管控权限，共享数据安全管控平台核心能力，包括资产管理、分类分级、告警分析、综合态势等。（多租户功能权限：租户管理可管理的功能权限采用可访问系统权限，数据权限：租户内可分配）

### 2.相关概念

1. 租户是一个概念， 创建租户时会有一个**默认用户**， 作为租户管理员，例如tenant；

   tenant创建用户时， 用户信息关联tenentId;

2. 超级管理员创建租户时能够选定**模块权限**；

3. 租户层面不需要和机构关联， 还是延续目前的逻辑， 由租户创建的用户关联机构；



### 3.改造点

1. 补齐目前用户中心table中缺失tenantId字段的表；

   **经讨论， 不需要添加tenant_id字段；**
   
2. 新建租户时查看关联了哪些表；

   租户表、用户表

   admin创建租户时， 租户的模块权限被限制在租户表的**open_product字段**中；

   目前测试， 租户在创建角色时， 获取到了全部模块的菜单【**应该只有open_product字段中的菜单！**】

   ![image-20241105145811356](img/image-20241105145811356.png)

   修改DictService中的getModuleDictCount方法， 对出参的moduleInfoList按照租户id对应的OpenProduct字段进行过滤

3. 测试目前用户中心的架构是否满足需求【租户、用户、角色、机构】 

   测试目前新增机构时，并没有关联租户id

### 4.主要问题

1. 表中id设置为自增；
2. deleted字段设置默认为0；
3. **新增用户和新增角色时， tenantId设置错误；**【例如tenant_id为4的租户管理员新增用户时， 用户关联的tenant_id为3】
4. **新增机构时没有绑定租户id**
5. 需要测试所有页面新增接口， 看看是否绑定了tenantId；
6. 操作日志表和部门表需要进行租户隔离【修改nacos中tenant-ignore-table列表，去掉\- expos_operation_log和 \- expos_sys_dept】





## 2、操作日志

### 1.要求

平台支持对所有操作日志进行展示与详情查看，能以操作时间、操作账号、操作类型、操作模块等要素进行检索。

### 2.改造点

1. 操作时间、操作账号、操作模块通过切面拦截Controller接口请求可以获取。操作类型需要接口添加功能说明注释，考虑在接口扫描时获取接口上的@ApiOperation注解信息，直接将接口功能扫描到接口表中；

2. 对于日志的记录、存储，需要和接口调用解耦， 以免影响接口响应时间、系统性能等；

   - 考虑在接口扫描时**异步入库**，使用@Ansy等， 不影响主线程的服务启动流程；

     扫描完成后， 将**接口-功能描述缓存**到redis中

   - 切面获取到接口调用信息，到入库， 采用事件监听机制，切面只关心发布事件，后续处理由事件监听器完成；

     监听器监听到事件时， 采用CompletableFuture进行服务编排以及异步处理， 先根据事件中的url查询相关的功能描述，then将组装好的操作日志信息进行入库；



### 3.问题

1. 用户中心操作日志通过@OperationLog实现；

    但插件中还有一套@MethodLog实现，用于获取其他服务的日志发送kafka

   IAM收到日志后，KafkaOperationLogReceiver中 转成了OperationEvent。。。【真乱啊】

   【在LogServicez中的getMethodRemark里，得将模块名、服务名set进去， 现在操作日志里只有用户中心的日志】



### 4.开发内容

1. 确认接口描述是从@ApiOperation注解上获取， 还是直接由@OperationLog和@MethodLog注解上获取；
   - 从@ApiOperation注解上获取，需要在插件的接口扫描中同时入库接口描述， 并在日志处理切面中关联查询描述入库日志；
   - 从@MethodLog注解上获取， 需要所有模块的接口， 在@MethodLog的使用上， 添填写remark字段；
2. 日志管理页面， 需要新增根据操作类型检索接口；【那么操作类型只能根据枚举来定义， 例如新增、查询、删除、更新】
3. 日志管理页面新增详情查看接口， 操作详情拼接【用户-操作-接口功能描述-时间等】



## 3、认证安全

### 0.需求修正

![image-20241106150813565](img/image-20241106150813565.png)

只做这一个页面；

等这个页面具备了再做联动吧；

### 1.要求

平台支持提供登录安全设置，包括登录连续失败锁定用户、登录超时时间等；支持提供密码策略设置，包括密码最小长度、密码最大长度、特殊字符、大小写字母、密码复杂度等。

### 2.相关梳理

1. 密码策略页面的编辑对应nacos中的**password_config**;
2. 连续失败锁定用户在oidccontroller的login接口中；
3. 登录超时时间对应token过期时间；

### 3.改造点

1. 测试这些功能是否具备；
2. 认证因子与前端配置联动；

### 4.开发内容

~~在login接口中增加认证策略， 关联数据库中的认证方式【密码、短信、邮箱、验证码】~~

**具体开发事项**：

1. 目前短信邮箱等没有一个通用的方法， 都是定制化开发， 需要开发一个**通用方法**，兼容不同的短信、邮箱网关；
2. **待确认认证方式是全局的还是与用户绑定？**
3. 待确认登录超时时间是否对应token过期时间；



